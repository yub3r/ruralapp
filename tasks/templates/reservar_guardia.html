{% extends 'base.html' %}

{% block content %}
{% load crispy_forms_tags %}

<script>
    document.addEventListener('DOMContentLoaded', function () {
        const fechaInicio = document.querySelector('#id_fecha_inicio');
        const fechaFin = document.querySelector('#id_fecha_fin');
        const horaInicio = document.querySelector('#id_hora_inicio');
        const horaFin = document.querySelector('#id_hora_fin');
        const form = document.querySelector('form');
        const submitButton = form.querySelector('input[type="submit"]');

        // Establecer horas fijas por defecto para las guardias
        const DEFAULT_START_TIME = '16:00';
        const DEFAULT_END_TIME = '07:00';
        const DURATION_DAYS = 3; // La guardia termina al 3er día (día de inicio + 3 días)

        // Función para actualizar fecha y hora de fin automáticamente
        function actualizarFechaYHoraFin() {
            const fechaInicioValue = fechaInicio.value;
            if (fechaInicioValue) {
                const fechaInicioObj = new Date(fechaInicioValue + 'T' + DEFAULT_START_TIME); // Usamos 'T' y la hora para parsear correctamente

                // Calcular la fecha de fin: fecha de inicio + 3 días
                const fechaFinObj = new Date(fechaInicioObj);
                fechaFinObj.setDate(fechaInicioObj.getDate() + DURATION_DAYS);

                // Formatear la fecha de fin a YYYY-MM-DD
                const nuevaFechaFin = fechaFinObj.toISOString().slice(0, 10);
                
                // Asignar los valores a los campos
                fechaFin.value = nuevaFechaFin;
                horaInicio.value = DEFAULT_START_TIME;
                horaFin.value = DEFAULT_END_TIME;

                validarFormulario(); 
            } else {
                // Si la fecha de inicio está vacía, limpiar también fecha y hora de fin
                fechaFin.value = '';
                horaInicio.value = DEFAULT_START_TIME; // O podrías limpiar este también, depende de la UX deseada
                horaFin.value = DEFAULT_END_TIME; // O podrías limpiar este también
            }
        }

        // Validación de formulario (frontend)
        function validarFormulario() {
            let mensajeError = "";
            const fechaInicioValue = new Date(fechaInicio.value + 'T00:00:00'); // Normalizar a inicio del día
            const fechaFinValue = new Date(fechaFin.value + 'T00:00:00'); // Normalizar a inicio del día
            const today = new Date();
            today.setHours(0,0,0,0); // Normalizar a inicio del día

            // Validar que la fecha de inicio no sea anterior al día actual
            if (fechaInicio.value && fechaInicioValue < today) {
                mensajeError = "No se pueden reservar guardias en el pasado.";
            } else if (fechaInicio.value && fechaFin.value && fechaInicioValue > fechaFinValue) {
                // Validación para asegurar que fecha_fin no sea anterior a fecha_inicio
                mensajeError = "La fecha de fin debe ser posterior o igual a la fecha de inicio.";
            }
            // La validación de hora_inicio >= hora_fin en el mismo día es más compleja para guardias que cruzan la medianoche
            // y se delega al backend, pero un chequeo simple de hora_inicio == hora_fin podría mantenerse si fuera una duración 0
            // dado que las horas son fijas (16:00 a 07:00), esta validación específica no es tan crítica en el frontend.

            if (mensajeError) {
                Swal.fire({
                    icon: 'error',
                    title: 'Error de validación',
                    text: mensajeError,
                });
                submitButton.disabled = true;
                return false;
            } else {
                submitButton.disabled = false;
                return true;
            }
        }
        
        // Asignar los listeners de eventos
        fechaInicio.addEventListener('change', actualizarFechaYHoraFin); // Llamar al cambiar la fecha de inicio

        // Aquí no necesitas listeners para horaInicio, horaFin o fechaFin, ya que se calculan automáticamente
        // si el usuario los manipula, serán sobrescritos si la fecha de inicio cambia de nuevo.
        // Si el usuario puede cambiar la fecha_fin o las horas manualmente, deberíamos reevaluar.
        // Asumo que hora_inicio y hora_fin son FIJAS, y fecha_fin se calcula.
        fechaFin.addEventListener('change', validarFormulario);
        horaInicio.addEventListener('change', validarFormulario); // Aunque las horas se auto-establecen, si las cambian manualmente, que valide
        horaFin.addEventListener('change', validarFormulario);   // Idem

        // Inicializar los campos con los valores predeterminados al cargar la página
        // y si la fecha de inicio ya tiene un valor (por ejemplo, si se edita un registro)
        horaInicio.value = DEFAULT_START_TIME;
        horaFin.value = DEFAULT_END_TIME;
        if (fechaInicio.value) { // Si ya hay una fecha de inicio (ej. edición), calcular fecha de fin
            actualizarFechaYHoraFin();
        } else { // Si es un nuevo registro, establecer solo las horas por defecto
            // No establecemos la fecha de fin si no hay fecha de inicio para evitar una fecha "flotante"
        }

        // Asegurarse de que el formulario se valide al cargar la página en caso de datos pre-cargados
        validarFormulario();

        // Lógica para los inputs de tipo 'date' (simplificada para que el navegador los maneje)
        fechaInicio.type = 'date';
        fechaFin.type = 'date';

        // Para el botón de reset, recargar la página
        const resetButton = document.querySelector('button[type="reset"]');
        if (resetButton) {
            resetButton.addEventListener('click', function(event) {
                event.preventDefault();
                location.reload();
            });
        }
    });
</script>

<h1 class="display-6 text-center">Reservar Guardia</h1>

<form action="{% url 'reservar_guardia' %}" method="POST" style="display: flex; flex-direction: column; max-width:580px; margin-inline: auto ">
    {% csrf_token %}
    <div class="form-check-inline">
        {{ form|crispy }}
        <style type="text/css">
            #div_id_tarea>* {
                display: flex;
                justify-content: center;
            }
        </style>
    </div>
    <p><br></p>
    {% if messages %}
        <div>
            {% for message in messages %}
                <div class="alert alert-danger">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}
    <input class="btn btn-primary w-100" type="submit" value="Asignar" />
    <div class="d-flex" style="margin-top: 8px">
        <button type="reset" style="margin-top: 8px" class="btn btn-outline-secondary flex-fill me-3">Reset</button>
        <a href="{% url 'guardias' %}" style="margin-top: 8px" class="btn btn-secondary flex-fill">Cancelar</a>
    </div>
</form>
{% endblock %}