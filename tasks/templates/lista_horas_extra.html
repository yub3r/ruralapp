{% extends 'base.html' %}

{% block js %}
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.getElementById('cargarGuardiasForm');
    form.addEventListener('submit', function (event) {
        event.preventDefault(); // Evita el envío inmediato del formulario

        fetch(form.action, {
            method: 'POST',
            body: new FormData(form),
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const mensaje = data.registros > 0
                    ? `${data.mensaje}<br>(${data.fecha_inicio} a ${data.fecha_fin})`
                    : data.mensaje;

                Swal.fire({
                    icon: data.registros > 0 ? 'success' : 'info',
                    title: data.registros > 0 ? 'Guardias cargadas' : 'Nada nuevo',
                    html: mensaje,
                    confirmButtonText: 'Aceptar'
                }).then((result) => {
                    if (result.isConfirmed) {
                        location.reload(); // Recargar la página tras aceptar el mensaje
                    }
                });
            } else {
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    title: 'Error',
                    text: 'Hubo un problema al cargar las guardias.',
                    confirmButtonText: 'Cerrar'
                });
            }
        })
        .catch(error => {
            Swal.fire({
                icon: 'error',
                title: 'Error',
                text: 'Hubo un problema con la solicitud.',
                confirmButtonText: 'Cerrar'
            });
        });
    });

    // Lógica para los botones de filtro de grupo
    document.querySelectorAll('.filter-button').forEach(button => {
        button.addEventListener('click', function() {
            const grupo = this.dataset.grupo;
            const currentUrl = new URL(window.location.href);
            currentUrl.searchParams.set('grupo', grupo);
            window.location.href = currentUrl.toString();
        });
    });

    // Lógica para el botón "Mostrar Todos"
    document.getElementById('show-all-button').addEventListener('click', function() {
        const currentUrl = new URL(window.location.href);
        currentUrl.searchParams.delete('grupo'); // Eliminar el parámetro de grupo
        window.location.href = currentUrl.toString();
    });
});
</script>
{% endblock %}


{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="text-center mb-0">Lista de Horas Extra por Usuario</h2>
    <div class="d-flex align-items-center gap-2"> {# Contenedor para los botones de filtro y cargar guardias #}
        {# Botones de filtro de grupo #}
        <button class="btn btn-outline-primary btn-sm filter-button {% if filtro_activo == 'OPS' %}active{% endif %}" data-grupo="OPS">OPS</button>
        <button class="btn btn-outline-primary btn-sm filter-button {% if filtro_activo == 'MTO' %}active{% endif %}" data-grupo="MTO">MTO</button>
        <button class="btn btn-outline-primary btn-sm filter-button {% if filtro_activo == 'IT' %}active{% endif %}" data-grupo="IT">IT</button>
        <button id="show-all-button" class="btn btn-outline-secondary btn-sm {% if not filtro_activo %}active{% endif %}">Todos</button>
        {# Botón de Cargar Guardias #}
        <form method="POST" action="{% url 'cargar_guardias_a_horas_extra' %}" id="cargarGuardiasForm" class="ms-3">
            {% csrf_token %}
            <button type="submit" class="btn btn-warning px-4"><i class="bi bi-calendar-check-fill"></i> Cargar Guardias</button>
        </form>
    </div>
</div>

<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Desde/Inicio</th>
            <th>Hasta/Fin</th>
            <th>Justificación</th>
            <th>%/H</th>
            <th>Horas</th>
            <th>Acción</th>
        </tr>
    </thead>
    <tbody>
        {% for horas in horas_extras %}
        {% if horas.aprobado is None %}
        <tr>
            <td style="text-align: left; vertical-align: middle;">{{ horas.usuario.username }}</td>
            <td style="text-align: center; vertical-align: middle;">{{ horas.fecha_inicio|date:"d/m/y" }} {{ horas.hora_inicio|time:"H:i" }}</td>
            <td style="text-align: center; vertical-align: middle;">{{ horas.fecha_fin|date:"d/m/y" }} {{ horas.hora_fin|time:"H:i" }}</td>
            <td>{{ horas.justificar|default:"-" }}</td>
            <td style="text-align: left; vertical-align: middle;">{{ horas.porcent }}</td>
            <td style="text-align: left; vertical-align: middle;">{{ horas.total_horas }}</td>
            <td>
                <form method="post" action="{% url 'aprobar_rechazar_horas_extra' horas.id %}">
                    {% csrf_token %}
                    <input type="text" name="feedback" placeholder="Escriba el feedback" class="form-control mb-2">
                    {# Campo oculto para mantener el filtro actual #}
                    <input type="hidden" name="filtro_grupo" value="{{ filtro_activo|default:'' }}">
                    <div class="d-flex gap-2">
                        <button type="submit" name="accion" value="aprobar" class="btn btn-success btn-sm flex-fill">
                            <i class="bi bi-hand-thumbs-up-fill"></i>Aprobar
                        </button>
                        <button type="submit" name="accion" value="rechazar" class="btn btn-danger btn-sm flex-fill">
                            <i class="bi bi-hand-thumbs-down-fill"></i>Rechazar
                        </button>
                    </div>
                </form>
            </td>
        </tr>
        {% endif %}
        {% empty %}
        <tr>
            <td colspan="7" class="text-center">No hay registros de horas extras.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
<style>
    table.table tbody tr {
        height: 30px;
        line-height: 1;
    }
    table.table td {
        padding: 4px 8px;
    }
    .table-container {
        border: 1px solid #ddd;
        padding: 10px;
        background: #f9f9f9;
        height: 100%;
    }
    .d-flex {
        display: flex;
        gap: 10px;
    }
</style>

{% endblock %}