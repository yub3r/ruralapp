{% extends 'base.html' %}
{% block js %}

<script>
$(document).ready(function() {
    // Definir un tipo de ordenamiento para fechas con hora en formato d/m/y H:i
    $.fn.dataTable.ext.type.order['datetime-custom-pre'] = function (data) {
        if (!data) {
            return 0;
        }
        var parts = data.split(' ');
        if (parts.length !== 2) {
            return 0;
        }
        var dateParts = parts[0].split('/');
        var timeParts = parts[1].split(':');
        return new Date(parseInt(dateParts[2], 10),
                        parseInt(dateParts[1], 10) - 1,
                        parseInt(dateParts[0], 10),
                        parseInt(timeParts[0], 10),
                        parseInt(timeParts[1], 10)).getTime();
    };

    var table = $('.table').DataTable({
        "order": [[1, "desc"]],
        "scrollY": "640px",
        "columnDefs": [
            { "orderable": false, "targets": [3, 6, 8] }, // Ajusté los targets no ordenables
            { "type": "datetime-custom", "targets": [1, 2] }, // Aplica el tipo personalizado a "Desde/Ini" y "Hasta/Fin"
            {
                "targets": [7],
                "type": "datetime-custom",
                "render": function(data, type, row) {
                    return type === 'sort' || type === 'type' ? row[7] : data; // Usa el valor original para mostrar
                }
            }
        ],
        "language": {
            "search": "Buscar:",
            "lengthMenu": "Mostrar _MENU_ registros por página",
            "zeroRecords": "No se encontraron registros",
            "info": "Mostrando _START_ a _END_ de _TOTAL_ registros",
            "infoEmpty": "No hay registros disponibles",
            "infoFiltered": "(filtrado de _MAX_ registros totales)"
        }
    });

    // Filtrado por rango de fechas (sin cambios)
    $('#start-date, #end-date').on('change', function() {
        table.draw();
    });

    // Clear filters (sin cambios)
    $('#clear-dates').on('click', function() {
        $('#start-date').val('');
        $('#end-date').val('');
        table.draw();
    });

    // Filtro personalizado (sin cambios, pero ahora usa data-date)
    $.fn.dataTable.ext.search.push(function(settings, data, dataIndex) {
        var startDateInput = $('#start-date').val() ? new Date($('#start-date').val()) : null;
        var endDateInput = $('#end-date').val() ? new Date($('#end-date').val()) : null;

        var row = table.row(dataIndex).node();
        var startDateData = $(row).find('td').eq(1).data('date'); // Desde/Inicio
        var endDateData = $(row).find('td').eq(2).data('date');   // Hasta/Fin
        var reviewDateData = $(row).find('td').eq(7).data('date'); // Fecha de Revisión (si la tuvieras como data-date)

        var startDateRow = startDateData ? new Date(startDateData) : null;
        var endDateRow = endDateData ? new Date(endDateData) : null;
        var reviewDateRow = reviewDateData ? new Date(reviewDateData) : null;

        if (
            (!startDateInput && !endDateInput) ||
            (!startDateInput && endDateRow <= endDateInput) ||
            (!endDateInput && startDateRow >= startDateInput) ||
            (startDateRow >= startDateInput && endDateRow <= endDateInput)
        ) {
            return true;
        }
        return false;
    });
});
</script>


{% endblock %}
{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2 class="mb-0">Horas Extras Verificadas</h2>
    <div class="d-flex align-items-center">
        <label for="filter-date-range" class="me-2">Filtrar:</label>
        <input type="date" id="start-date" class="form-control form-control-sm me-1">
        <span>a</span>
        <input type="date" id="end-date" class="form-control form-control-sm mx-1">
        <button id="clear-dates" class="btn btn-secondary btn-sm">Clear</button>
    </div>
</div>


<table class="table table-striped table-hover">
    <thead>
        <tr>
            <th>Usuario</th>
            <th>Desde/Ini</th>
            <th>Hasta/Fin</th>
            <th>Justificación</th>
            <th>%/H</th>
            <th>Horas</th>
            <th>Estado</th>
            <th style="text-align: center; vertical-align: middle;">Fecha de Revisión</th>
            <th>Feedback</th> {# Este es el encabezado de la columna donde integrarás la información #}
        </tr>
    </thead>
    <tbody>
        {% for horas in horas_extras %}
        <tr>
            <td style="text-align: left; vertical-align: middle;">{{ horas.usuario.username }}</td>
            <td style="text-align: center; vertical-align: middle;" data-date="{{ horas.fecha_inicio|date:"Y-m-d" }}">
                {{ horas.fecha_inicio|date:"d/m/y" }} {{ horas.hora_inicio|time:"H:i" }}
            </td>
            <td style="text-align: center; vertical-align: middle;" data-date="{{ horas.fecha_fin|date:"Y-m-d" }}">
                {{ horas.fecha_fin|date:"d/m/y" }} {{ horas.hora_fin|time:"H:i" }}
            </td>
            <td>{{ horas.justificar|default:"-" }}</td>
            <td style="text-align: left; vertical-align: middle;">{{ horas.porcent }}</td>
            <td style="text-align: left; vertical-align: middle;">{{ horas.total_horas }}</td>
            <td style="text-align: center; vertical-align: middle;">
                {% if horas.aprobado %}
                    <span class="text-success">Aprobado</span>
                {% else %}
                    <span class="text-danger">Rechazado</span>
                {% endif %}
            </td>
            <td style="text-align: center; vertical-align: middle;">
                {{ horas.fecha_aprobacion|date:"d/m/y H:i" }}
            </td>
            <td>
                {# Aquí combinamos el usuario que aprueba/rechaza y el feedback #}
                {% if horas.aprobado_por %}
                    <strong>{{ horas.aprobado_por.username }}:</strong>
                    {% if horas.feedback_admin %}
                        {{ horas.feedback_admin }}
                    {% else %}
                        -
                    {% endif %}
                {% else %}
                    {# En caso de que por alguna razón aprobado_por sea nulo (no debería pasar si aprobado is not None) #}
                    {{ horas.feedback_admin|default:"-" }}
                {% endif %}
            </td>
        </tr>
        {% empty %}
        <tr>
            <td colspan="9" class="text-center">No hay registros de horas extras aprobadas o rechazadas.</td>
        </tr>
        {% endfor %}
    </tbody>
</table>
{% endblock %}